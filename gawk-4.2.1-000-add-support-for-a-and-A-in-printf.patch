From 51e6897a1dc72dd5e39921e8a1c8fa4efb568ca6 Mon Sep 17 00:00:00 2001
From: "Arnold D. Robbins" <arnold@skeeve.com>
Date: Thu, 22 Mar 2018 18:37:52 +0200
Subject: [PATCH] Add support for %a and %A in printf.

---
 NEWS            |   5 +
 builtin.c       |  31 +-
 configh.in      |   3 +
 configure       |  42 +++
 configure.ac    |  28 ++
 doc/awkcard.in  |   1 +
 doc/gawk.1      |  12 +-
 doc/gawk.info   | 925 ++++++++++++++++++++++++++++----------------------------
 doc/gawk.texi   |  19 ++
 doc/gawktexi.in |  19 ++
 doc/wordlist    |   2 +
 doc/wordlist2   |   1 +
 pc/config.h     |   3 +
 pc/config.sed   |   2 +
 14 files changed, 631 insertions(+), 462 deletions(-)

diff --git a/NEWS b/NEWS
index c2885c8..71d9608 100644
--- a/NEWS
+++ b/NEWS
@@ -5,6 +5,11 @@
    are permitted in any medium without royalty provided the copyright
    notice and this notice are preserved.
 
+Changes from 4.2.1 to 4.2.2
+---------------------------
+
+1. Support for the POSIX standard %a and %A formats has been added.
+
 Changes from 4.2.0 to 4.2.1
 ---------------------------
 
diff --git a/builtin.c b/builtin.c
index 6927205..c54be9b 100644
--- a/builtin.c
+++ b/builtin.c
@@ -1493,6 +1493,17 @@ mpf1:
 		case 'e':
 		case 'f':
 		case 'E':
+#if defined(PRINTF_HAS_A_FORMAT) && PRINTF_HAS_A_FORMAT == 1
+		case 'A':
+		case 'a':
+		{
+			static bool warned = false;
+			if (do_lint && tolower(cs1) == 'a' && ! warned) {
+				warned = true;
+				lintwarn(_("%%%c format is POSIX standard but not portable to other awks"), cs1);
+			}
+		}
+#endif
 			need_format = false;
 			parse_next_arg();
 			(void) force_number(arg);
@@ -1557,11 +1568,21 @@ mpf1:
 				break;
 #endif
 			default:
-				sprintf(cp, "*.*%c", cs1);
-				while ((nc = snprintf(obufout, ofre, cpbuf,
-					     (int) fw, (int) prec,
-					     (double) tmpval)) >= ofre)
-					chksize(nc)
+				if (have_prec || tolower(cs1) != 'a') {
+					sprintf(cp, "*.*%c", cs1);
+					while ((nc = snprintf(obufout, ofre, cpbuf,
+						     (int) fw, (int) prec,
+						     (double) tmpval)) >= ofre)
+						chksize(nc)
+				} else {
+					// For %a and %A, use the default precision if it
+					// wasn't supplied by the user.
+					sprintf(cp, "*%c", cs1);
+					while ((nc = snprintf(obufout, ofre, cpbuf,
+						     (int) fw,
+						     (double) tmpval)) >= ofre)
+						chksize(nc)
+				}
 			}
 
 #if defined(LC_NUMERIC)
diff --git a/configh.in b/configh.in
index e600005..8c4d94d 100644
--- a/configh.in
+++ b/configh.in
@@ -368,6 +368,9 @@
 /* Define to the version of this package. */
 #undef PACKAGE_VERSION
 
+/* Define to 1 if *printf supports %a format */
+#undef PRINTF_HAS_A_FORMAT
+
 /* Define to 1 if *printf supports %F format */
 #undef PRINTF_HAS_F_FORMAT
 
diff --git a/configure b/configure
index 2283f09..f492a75 100755
--- a/configure
+++ b/configure
@@ -10210,6 +10210,48 @@ fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $has_f_format" >&5
 $as_echo "$has_f_format" >&6; }
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for printf %a format" >&5
+$as_echo_n "checking for printf %a format... " >&6; }
+if test "$cross_compiling" = yes; then :
+  has_a_format=no
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+
+#include <stdio.h>
+
+int main()
+{
+	char buf[100];
+
+	sprintf(buf, "%a", 8.0);
+
+	if (strncmp(buf, "0x", 2) == 0)
+		return 0;
+	else
+		return 1;
+}
+
+_ACEOF
+if ac_fn_c_try_run "$LINENO"; then :
+  has_a_format=yes
+else
+  has_a_format=no
+fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
+fi
+
+if test "$has_a_format" = yes
+then
+
+$as_echo "#define PRINTF_HAS_A_FORMAT 1" >>confdefs.h
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $has_a_format" >&5
+$as_echo "$has_a_format" >&6; }
+
 
 gawk_have_sockets=no
 # Check for system-dependent location of socket libraries
diff --git a/configure.ac b/configure.ac
index f45c710..a4817ee 100644
--- a/configure.ac
+++ b/configure.ac
@@ -395,6 +395,34 @@ then
 fi
 AC_MSG_RESULT($has_f_format)
 
+dnl check for printf %a format
+AC_MSG_CHECKING([for printf %a format])
+AC_RUN_IFELSE([
+AC_LANG_SOURCE([
+#include <stdio.h>
+
+int main()
+{
+	char buf[[100]];
+
+	sprintf(buf, "%a", 8.0);
+
+	if (strncmp(buf, "0x", 2) == 0)
+		return 0;
+	else
+		return 1;
+}
+])],
+	has_a_format=yes,
+	has_a_format=no,
+	has_a_format=no  dnl Cross-compiling, assuming the worst.
+)
+if test "$has_a_format" = yes
+then
+	AC_DEFINE(PRINTF_HAS_A_FORMAT, 1, [Define to 1 if *printf supports %a format])
+fi
+AC_MSG_RESULT($has_a_format)
+
 dnl check for sockets
 GAWK_AC_LIB_SOCKETS
 
diff --git a/doc/awkcard.in b/doc/awkcard.in
index 1148294..d4df342 100644
--- a/doc/awkcard.in
+++ b/doc/awkcard.in
@@ -1431,6 +1431,7 @@ the error.\*(CX
 accept the following conversion specification formats:
 .sp .5
 .nf
+\*(CB\*(FC%a\fP, \*(FC%A\fP	A C99 floating point hexadecimal number\*(CD
 \*(FC%c\fP		An \s-1ASCII\s+1 character
 \*(FC%d\fP, \*(FC%i\fP	A decimal number (the integer part)
 \*(FC%e\fP		A floating point number of the form
diff --git a/doc/gawk.1 b/doc/gawk.1
index 16762a8..48c07b7 100644
--- a/doc/gawk.1
+++ b/doc/gawk.1
@@ -13,7 +13,7 @@
 .		if \w'\(rq' .ds rq "\(rq
 .	\}
 .\}
-.TH GAWK 1 "Feb 15 2018" "Free Software Foundation" "Utility Commands"
+.TH GAWK 1 "Mar 22 2018" "Free Software Foundation" "Utility Commands"
 .SH NAME
 gawk \- pattern scanning and processing language
 .SH SYNOPSIS
@@ -1264,7 +1264,7 @@ behavior:
 \fBPROCINFO["NONFATAL"]\fR
 If this exists, then I/O errors for all redirections become nonfatal.
 .TP
-\fBPROCINFO["\fname\fB", "NONFATAL"]\fR
+\fBPROCINFO["\fIname\fB", "NONFATAL"]\fR
 Make I/O errors for
 .I name
 be nonfatal.
@@ -2429,6 +2429,14 @@ function
 (see below)
 accept the following conversion specification formats:
 .TP "\w'\fB%g\fR, \fB%G\fR'u+2n"
+.BR "%a" "," " %A"
+A floating point number of the form
+[\fB\-\fP]\fB0x\fIh\fB.\fIhhhh\fBp+\-\fIdd\fR
+(C99 hexadecimal floating point format).
+For
+.BR %A ,
+uppercase letters are used instead of lowercase ones.
+.TP
 .B %c
 A single character.
 If the argument used for
diff --git a/doc/gawk.info b/doc/gawk.info
index 738de09..c01e43b 100644
--- a/doc/gawk.info
+++ b/doc/gawk.info
@@ -6614,6 +6614,21 @@ print.  The rest of the format specifier is made up of optional
 "modifiers" that control _how_ to print the value, such as the field
 width.  Here is a list of the format-control letters:
 
+'%a', '%A'
+     A floating point number of the form ['-']'0xH.HHHHp+-DD' (C99
+     hexadecimal floating point format).  For '%A', uppercase letters
+     are used instead of lowercase ones.
+
+          NOTE: While the current POSIX standard requires support for
+          '%a' and '%A' in 'awk', as far as we know, no other version of
+          'awk' actually implements it.  It's use is thus highly
+          nonportable!
+
+          Furthermore, these formats are not available on any system
+          where the underlying C library 'printf()' function does not
+          support them.  As of this writing, among current systems, only
+          OpenVMS is known to not support them.
+
 '%c'
      Print a number as a character; thus, 'printf "%c", 65' outputs the
      letter 'A'.  The output for a string value is the first character
@@ -33759,9 +33774,9 @@ Index
 * dark corner, FILENAME variable:        Getline Notes.       (line  19)
 * dark corner, FILENAME variable <1>:    Auto-set.            (line 108)
 * dark corner, FNR/NR variables:         Auto-set.            (line 389)
-* dark corner, format-control characters: Control Letters.    (line  18)
+* dark corner, format-control characters: Control Letters.    (line  33)
 * dark corner, format-control characters <1>: Control Letters.
-                                                              (line  93)
+                                                              (line 108)
 * dark corner, FS as null string:        Single Character Fields.
                                                               (line  20)
 * dark corner, input files:              awk split records.   (line 110)
@@ -34459,8 +34474,8 @@ Index
 * gawk, FIELDWIDTHS variable in:         Fixed width data.    (line  17)
 * gawk, FIELDWIDTHS variable in <1>:     User-modified.       (line  37)
 * gawk, file names in:                   Special Files.       (line   6)
-* gawk, format-control characters:       Control Letters.     (line  18)
-* gawk, format-control characters <1>:   Control Letters.     (line  93)
+* gawk, format-control characters:       Control Letters.     (line  33)
+* gawk, format-control characters <1>:   Control Letters.     (line 108)
 * gawk, FPAT variable in:                Splitting By Content.
                                                               (line  25)
 * gawk, FPAT variable in <1>:            User-modified.       (line  46)
@@ -36129,456 +36144,456 @@ Node: OFMT288591
 Node: Printf289947
 Node: Basic Printf290732
 Node: Control Letters292306
-Node: Format Modifiers296302
-Node: Printf Examples302317
-Node: Redirection304803
-Node: Special FD311644
-Ref: Special FD-Footnote-1314812
-Node: Special Files314886
-Node: Other Inherited Files315503
-Node: Special Network316504
-Node: Special Caveats317364
-Node: Close Files And Pipes318313
-Ref: table-close-pipe-return-values325220
-Ref: Close Files And Pipes-Footnote-1326033
-Ref: Close Files And Pipes-Footnote-2326181
-Node: Nonfatal326333
-Node: Output Summary328671
-Node: Output Exercises329893
-Node: Expressions330572
-Node: Values331760
-Node: Constants332438
-Node: Scalar Constants333129
-Ref: Scalar Constants-Footnote-1333993
-Node: Nondecimal-numbers334243
-Node: Regexp Constants337244
-Node: Using Constant Regexps337770
-Node: Standard Regexp Constants338392
-Node: Strong Regexp Constants341580
-Node: Variables344538
-Node: Using Variables345195
-Node: Assignment Options347105
-Node: Conversion348978
-Node: Strings And Numbers349502
-Ref: Strings And Numbers-Footnote-1352565
-Node: Locale influences conversions352674
-Ref: table-locale-affects355432
-Node: All Operators356050
-Node: Arithmetic Ops356679
-Node: Concatenation359185
-Ref: Concatenation-Footnote-1362032
-Node: Assignment Ops362139
-Ref: table-assign-ops367130
-Node: Increment Ops368443
-Node: Truth Values and Conditions371903
-Node: Truth Values372977
-Node: Typing and Comparison374025
-Node: Variable Typing374845
-Ref: Variable Typing-Footnote-1381308
-Ref: Variable Typing-Footnote-2381380
-Node: Comparison Operators381457
-Ref: table-relational-ops381876
-Node: POSIX String Comparison385371
-Ref: POSIX String Comparison-Footnote-1387066
-Ref: POSIX String Comparison-Footnote-2387205
-Node: Boolean Ops387289
-Ref: Boolean Ops-Footnote-1391771
-Node: Conditional Exp391863
-Node: Function Calls393599
-Node: Precedence397476
-Node: Locales401135
-Node: Expressions Summary402767
-Node: Patterns and Actions405340
-Node: Pattern Overview406460
-Node: Regexp Patterns408137
-Node: Expression Patterns408679
-Node: Ranges412460
-Node: BEGIN/END415568
-Node: Using BEGIN/END416329
-Ref: Using BEGIN/END-Footnote-1419065
-Node: I/O And BEGIN/END419171
-Node: BEGINFILE/ENDFILE421485
-Node: Empty424398
-Node: Using Shell Variables424715
-Node: Action Overview426989
-Node: Statements429314
-Node: If Statement431162
-Node: While Statement432657
-Node: Do Statement434685
-Node: For Statement435833
-Node: Switch Statement439004
-Node: Break Statement441390
-Node: Continue Statement443482
-Node: Next Statement445309
-Node: Nextfile Statement447692
-Node: Exit Statement450344
-Node: Built-in Variables452747
-Node: User-modified453880
-Node: Auto-set461647
-Ref: Auto-set-Footnote-1477946
-Ref: Auto-set-Footnote-2478152
-Node: ARGC and ARGV478208
-Node: Pattern Action Summary482421
-Node: Arrays484851
-Node: Array Basics486180
-Node: Array Intro487024
-Ref: figure-array-elements488999
-Ref: Array Intro-Footnote-1491703
-Node: Reference to Elements491831
-Node: Assigning Elements494295
-Node: Array Example494786
-Node: Scanning an Array496545
-Node: Controlling Scanning499567
-Ref: Controlling Scanning-Footnote-1504966
-Node: Numeric Array Subscripts505282
-Node: Uninitialized Subscripts507466
-Node: Delete509085
-Ref: Delete-Footnote-1511837
-Node: Multidimensional511894
-Node: Multiscanning514989
-Node: Arrays of Arrays516580
-Node: Arrays Summary521347
-Node: Functions523440
-Node: Built-in524478
-Node: Calling Built-in525559
-Node: Numeric Functions527555
-Ref: Numeric Functions-Footnote-1531583
-Ref: Numeric Functions-Footnote-2531940
-Ref: Numeric Functions-Footnote-3531988
-Node: String Functions532260
-Ref: String Functions-Footnote-1555918
-Ref: String Functions-Footnote-2556046
-Ref: String Functions-Footnote-3556294
-Node: Gory Details556381
-Ref: table-sub-escapes558172
-Ref: table-sub-proposed559691
-Ref: table-posix-sub561054
-Ref: table-gensub-escapes562595
-Ref: Gory Details-Footnote-1563418
-Node: I/O Functions563572
-Ref: table-system-return-values570040
-Ref: I/O Functions-Footnote-1572020
-Ref: I/O Functions-Footnote-2572168
-Node: Time Functions572288
-Ref: Time Functions-Footnote-1582959
-Ref: Time Functions-Footnote-2583027
-Ref: Time Functions-Footnote-3583185
-Ref: Time Functions-Footnote-4583296
-Ref: Time Functions-Footnote-5583408
-Ref: Time Functions-Footnote-6583635
-Node: Bitwise Functions583901
-Ref: table-bitwise-ops584495
-Ref: Bitwise Functions-Footnote-1590540
-Ref: Bitwise Functions-Footnote-2590713
-Node: Type Functions590904
-Node: I18N Functions593655
-Node: User-defined595306
-Node: Definition Syntax596111
-Ref: Definition Syntax-Footnote-1601798
-Node: Function Example601869
-Ref: Function Example-Footnote-1604791
-Node: Function Caveats604813
-Node: Calling A Function605331
-Node: Variable Scope606289
-Node: Pass By Value/Reference609283
-Node: Return Statement612782
-Node: Dynamic Typing615761
-Node: Indirect Calls616691
-Ref: Indirect Calls-Footnote-1626943
-Node: Functions Summary627071
-Node: Library Functions629776
-Ref: Library Functions-Footnote-1633383
-Ref: Library Functions-Footnote-2633526
-Node: Library Names633697
-Ref: Library Names-Footnote-1637157
-Ref: Library Names-Footnote-2637380
-Node: General Functions637466
-Node: Strtonum Function638569
-Node: Assert Function641591
-Node: Round Function644917
-Node: Cliff Random Function646457
-Node: Ordinal Functions647473
-Ref: Ordinal Functions-Footnote-1650536
-Ref: Ordinal Functions-Footnote-2650788
-Node: Join Function650998
-Ref: Join Function-Footnote-1652768
-Node: Getlocaltime Function652968
-Node: Readfile Function656710
-Node: Shell Quoting658687
-Node: Data File Management660088
-Node: Filetrans Function660720
-Node: Rewind Function664816
-Node: File Checking666726
-Ref: File Checking-Footnote-1668060
-Node: Empty Files668261
-Node: Ignoring Assigns670240
-Node: Getopt Function671790
-Ref: Getopt Function-Footnote-1683259
-Node: Passwd Functions683459
-Ref: Passwd Functions-Footnote-1692298
-Node: Group Functions692386
-Ref: Group Functions-Footnote-1700284
-Node: Walking Arrays700491
-Node: Library Functions Summary703499
-Node: Library Exercises704905
-Node: Sample Programs705370
-Node: Running Examples706140
-Node: Clones706868
-Node: Cut Program708092
-Node: Egrep Program718021
-Ref: Egrep Program-Footnote-1725533
-Node: Id Program725643
-Node: Split Program729323
-Ref: Split Program-Footnote-1732781
-Node: Tee Program732910
-Node: Uniq Program735700
-Node: Wc Program743126
-Ref: Wc Program-Footnote-1747381
-Node: Miscellaneous Programs747475
-Node: Dupword Program748688
-Node: Alarm Program750718
-Node: Translate Program755573
-Ref: Translate Program-Footnote-1760138
-Node: Labels Program760408
-Ref: Labels Program-Footnote-1763759
-Node: Word Sorting763843
-Node: History Sorting767915
-Node: Extract Program769750
-Node: Simple Sed777280
-Node: Igawk Program780354
-Ref: Igawk Program-Footnote-1794685
-Ref: Igawk Program-Footnote-2794887
-Ref: Igawk Program-Footnote-3795009
-Node: Anagram Program795124
-Node: Signature Program798186
-Node: Programs Summary799433
-Node: Programs Exercises800647
-Ref: Programs Exercises-Footnote-1804776
-Node: Advanced Features804867
-Node: Nondecimal Data806857
-Node: Array Sorting808448
-Node: Controlling Array Traversal809148
-Ref: Controlling Array Traversal-Footnote-1817516
-Node: Array Sorting Functions817634
-Ref: Array Sorting Functions-Footnote-1822725
-Node: Two-way I/O822921
-Ref: Two-way I/O-Footnote-1829473
-Ref: Two-way I/O-Footnote-2829660
-Node: TCP/IP Networking829742
-Node: Profiling832860
-Ref: Profiling-Footnote-1841532
-Node: Advanced Features Summary841855
-Node: Internationalization843699
-Node: I18N and L10N845179
-Node: Explaining gettext845866
-Ref: Explaining gettext-Footnote-1851758
-Ref: Explaining gettext-Footnote-2851943
-Node: Programmer i18n852108
-Ref: Programmer i18n-Footnote-1857057
-Node: Translator i18n857106
-Node: String Extraction857900
-Ref: String Extraction-Footnote-1859032
-Node: Printf Ordering859118
-Ref: Printf Ordering-Footnote-1861904
-Node: I18N Portability861968
-Ref: I18N Portability-Footnote-1864424
-Node: I18N Example864487
-Ref: I18N Example-Footnote-1867293
-Node: Gawk I18N867366
-Node: I18N Summary868011
-Node: Debugger869352
-Node: Debugging870375
-Node: Debugging Concepts870816
-Node: Debugging Terms872625
-Node: Awk Debugging875200
-Node: Sample Debugging Session876106
-Node: Debugger Invocation876640
-Node: Finding The Bug878026
-Node: List of Debugger Commands884504
-Node: Breakpoint Control885837
-Node: Debugger Execution Control889531
-Node: Viewing And Changing Data892893
-Node: Execution Stack896267
-Node: Debugger Info897904
-Node: Miscellaneous Debugger Commands901975
-Node: Readline Support907037
-Node: Limitations907933
-Node: Debugging Summary910042
-Node: Arbitrary Precision Arithmetic911321
-Node: Computer Arithmetic912806
-Ref: table-numeric-ranges916572
-Ref: table-floating-point-ranges917065
-Ref: Computer Arithmetic-Footnote-1917723
-Node: Math Definitions917780
-Ref: table-ieee-formats921096
-Ref: Math Definitions-Footnote-1921699
-Node: MPFR features921804
-Node: FP Math Caution923522
-Ref: FP Math Caution-Footnote-1924594
-Node: Inexactness of computations924963
-Node: Inexact representation925923
-Node: Comparing FP Values927283
-Node: Errors accumulate928365
-Node: Getting Accuracy929798
-Node: Try To Round932508
-Node: Setting precision933407
-Ref: table-predefined-precision-strings934104
-Node: Setting the rounding mode935934
-Ref: table-gawk-rounding-modes936308
-Ref: Setting the rounding mode-Footnote-1940239
-Node: Arbitrary Precision Integers940418
-Ref: Arbitrary Precision Integers-Footnote-1943593
-Node: Checking for MPFR943742
-Node: POSIX Floating Point Problems945216
-Ref: POSIX Floating Point Problems-Footnote-1949087
-Node: Floating point summary949125
-Node: Dynamic Extensions951315
-Node: Extension Intro952868
-Node: Plugin License954134
-Node: Extension Mechanism Outline954931
-Ref: figure-load-extension955370
-Ref: figure-register-new-function956935
-Ref: figure-call-new-function958027
-Node: Extension API Description960089
-Node: Extension API Functions Introduction961731
-Node: General Data Types967271
-Ref: General Data Types-Footnote-1975632
-Node: Memory Allocation Functions975931
-Ref: Memory Allocation Functions-Footnote-1980141
-Node: Constructor Functions980240
-Node: Registration Functions983826
-Node: Extension Functions984511
-Node: Exit Callback Functions989726
-Node: Extension Version String990976
-Node: Input Parsers991639
-Node: Output Wrappers1004360
-Node: Two-way processors1008872
-Node: Printing Messages1011137
-Ref: Printing Messages-Footnote-11012308
-Node: Updating ERRNO1012461
-Node: Requesting Values1013200
-Ref: table-value-types-returned1013937
-Node: Accessing Parameters1014873
-Node: Symbol Table Access1016108
-Node: Symbol table by name1016620
-Node: Symbol table by cookie1018409
-Ref: Symbol table by cookie-Footnote-11022594
-Node: Cached values1022658
-Ref: Cached values-Footnote-11026194
-Node: Array Manipulation1026347
-Ref: Array Manipulation-Footnote-11027438
-Node: Array Data Types1027475
-Ref: Array Data Types-Footnote-11030133
-Node: Array Functions1030225
-Node: Flattening Arrays1034723
-Node: Creating Arrays1041699
-Node: Redirection API1046466
-Node: Extension API Variables1049299
-Node: Extension Versioning1050010
-Ref: gawk-api-version1050439
-Node: Extension GMP/MPFR Versioning1052170
-Node: Extension API Informational Variables1053798
-Node: Extension API Boilerplate1054871
-Node: Changes from API V11058845
-Node: Finding Extensions1060417
-Node: Extension Example1060976
-Node: Internal File Description1061774
-Node: Internal File Ops1065854
-Ref: Internal File Ops-Footnote-11077204
-Node: Using Internal File Ops1077344
-Ref: Using Internal File Ops-Footnote-11079727
-Node: Extension Samples1080001
-Node: Extension Sample File Functions1081530
-Node: Extension Sample Fnmatch1089179
-Node: Extension Sample Fork1090666
-Node: Extension Sample Inplace1091884
-Node: Extension Sample Ord1095101
-Node: Extension Sample Readdir1095937
-Ref: table-readdir-file-types1096826
-Node: Extension Sample Revout1097631
-Node: Extension Sample Rev2way1098220
-Node: Extension Sample Read write array1098960
-Node: Extension Sample Readfile1100902
-Node: Extension Sample Time1101997
-Node: Extension Sample API Tests1103345
-Node: gawkextlib1103837
-Node: Extension summary1106755
-Node: Extension Exercises1110457
-Node: Language History1111955
-Node: V7/SVR3.11113611
-Node: SVR41115763
-Node: POSIX1117197
-Node: BTL1118577
-Node: POSIX/GNU1119306
-Node: Feature History1125084
-Node: Common Extensions1140943
-Node: Ranges and Locales1142226
-Ref: Ranges and Locales-Footnote-11146842
-Ref: Ranges and Locales-Footnote-21146869
-Ref: Ranges and Locales-Footnote-31147104
-Node: Contributors1147325
-Node: History summary1153270
-Node: Installation1154650
-Node: Gawk Distribution1155594
-Node: Getting1156078
-Node: Extracting1157041
-Node: Distribution contents1158679
-Node: Unix Installation1165159
-Node: Quick Installation1165841
-Node: Shell Startup Files1168255
-Node: Additional Configuration Options1169344
-Node: Configuration Philosophy1171637
-Node: Non-Unix Installation1174006
-Node: PC Installation1174466
-Node: PC Binary Installation1175304
-Node: PC Compiling1175739
-Node: PC Using1176856
-Node: Cygwin1180071
-Node: MSYS1181170
-Node: VMS Installation1181671
-Node: VMS Compilation1182462
-Ref: VMS Compilation-Footnote-11183691
-Node: VMS Dynamic Extensions1183749
-Node: VMS Installation Details1185434
-Node: VMS Running1187687
-Node: VMS GNV1191966
-Node: VMS Old Gawk1192701
-Node: Bugs1193172
-Node: Bug address1193835
-Node: Usenet1196627
-Node: Maintainers1197404
-Node: Other Versions1198665
-Node: Installation summary1205427
-Node: Notes1206629
-Node: Compatibility Mode1207494
-Node: Additions1208276
-Node: Accessing The Source1209201
-Node: Adding Code1210638
-Node: New Ports1216857
-Node: Derived Files1221345
-Ref: Derived Files-Footnote-11226991
-Ref: Derived Files-Footnote-21227026
-Ref: Derived Files-Footnote-31227624
-Node: Future Extensions1227738
-Node: Implementation Limitations1228396
-Node: Extension Design1229579
-Node: Old Extension Problems1230733
-Ref: Old Extension Problems-Footnote-11232251
-Node: Extension New Mechanism Goals1232308
-Ref: Extension New Mechanism Goals-Footnote-11235672
-Node: Extension Other Design Decisions1235861
-Node: Extension Future Growth1237974
-Node: Old Extension Mechanism1238810
-Node: Notes summary1240573
-Node: Basic Concepts1241755
-Node: Basic High Level1242436
-Ref: figure-general-flow1242718
-Ref: figure-process-flow1243403
-Ref: Basic High Level-Footnote-11246704
-Node: Basic Data Typing1246889
-Node: Glossary1250217
-Node: Copying1282055
-Node: GNU Free Documentation License1319598
-Node: Index1344718
+Node: Format Modifiers296985
+Node: Printf Examples303000
+Node: Redirection305486
+Node: Special FD312327
+Ref: Special FD-Footnote-1315495
+Node: Special Files315569
+Node: Other Inherited Files316186
+Node: Special Network317187
+Node: Special Caveats318047
+Node: Close Files And Pipes318996
+Ref: table-close-pipe-return-values325903
+Ref: Close Files And Pipes-Footnote-1326716
+Ref: Close Files And Pipes-Footnote-2326864
+Node: Nonfatal327016
+Node: Output Summary329354
+Node: Output Exercises330576
+Node: Expressions331255
+Node: Values332443
+Node: Constants333121
+Node: Scalar Constants333812
+Ref: Scalar Constants-Footnote-1334676
+Node: Nondecimal-numbers334926
+Node: Regexp Constants337927
+Node: Using Constant Regexps338453
+Node: Standard Regexp Constants339075
+Node: Strong Regexp Constants342263
+Node: Variables345221
+Node: Using Variables345878
+Node: Assignment Options347788
+Node: Conversion349661
+Node: Strings And Numbers350185
+Ref: Strings And Numbers-Footnote-1353248
+Node: Locale influences conversions353357
+Ref: table-locale-affects356115
+Node: All Operators356733
+Node: Arithmetic Ops357362
+Node: Concatenation359868
+Ref: Concatenation-Footnote-1362715
+Node: Assignment Ops362822
+Ref: table-assign-ops367813
+Node: Increment Ops369126
+Node: Truth Values and Conditions372586
+Node: Truth Values373660
+Node: Typing and Comparison374708
+Node: Variable Typing375528
+Ref: Variable Typing-Footnote-1381991
+Ref: Variable Typing-Footnote-2382063
+Node: Comparison Operators382140
+Ref: table-relational-ops382559
+Node: POSIX String Comparison386054
+Ref: POSIX String Comparison-Footnote-1387749
+Ref: POSIX String Comparison-Footnote-2387888
+Node: Boolean Ops387972
+Ref: Boolean Ops-Footnote-1392454
+Node: Conditional Exp392546
+Node: Function Calls394282
+Node: Precedence398159
+Node: Locales401818
+Node: Expressions Summary403450
+Node: Patterns and Actions406023
+Node: Pattern Overview407143
+Node: Regexp Patterns408820
+Node: Expression Patterns409362
+Node: Ranges413143
+Node: BEGIN/END416251
+Node: Using BEGIN/END417012
+Ref: Using BEGIN/END-Footnote-1419748
+Node: I/O And BEGIN/END419854
+Node: BEGINFILE/ENDFILE422168
+Node: Empty425081
+Node: Using Shell Variables425398
+Node: Action Overview427672
+Node: Statements429997
+Node: If Statement431845
+Node: While Statement433340
+Node: Do Statement435368
+Node: For Statement436516
+Node: Switch Statement439687
+Node: Break Statement442073
+Node: Continue Statement444165
+Node: Next Statement445992
+Node: Nextfile Statement448375
+Node: Exit Statement451027
+Node: Built-in Variables453430
+Node: User-modified454563
+Node: Auto-set462330
+Ref: Auto-set-Footnote-1478629
+Ref: Auto-set-Footnote-2478835
+Node: ARGC and ARGV478891
+Node: Pattern Action Summary483104
+Node: Arrays485534
+Node: Array Basics486863
+Node: Array Intro487707
+Ref: figure-array-elements489682
+Ref: Array Intro-Footnote-1492386
+Node: Reference to Elements492514
+Node: Assigning Elements494978
+Node: Array Example495469
+Node: Scanning an Array497228
+Node: Controlling Scanning500250
+Ref: Controlling Scanning-Footnote-1505649
+Node: Numeric Array Subscripts505965
+Node: Uninitialized Subscripts508149
+Node: Delete509768
+Ref: Delete-Footnote-1512520
+Node: Multidimensional512577
+Node: Multiscanning515672
+Node: Arrays of Arrays517263
+Node: Arrays Summary522030
+Node: Functions524123
+Node: Built-in525161
+Node: Calling Built-in526242
+Node: Numeric Functions528238
+Ref: Numeric Functions-Footnote-1532266
+Ref: Numeric Functions-Footnote-2532623
+Ref: Numeric Functions-Footnote-3532671
+Node: String Functions532943
+Ref: String Functions-Footnote-1556601
+Ref: String Functions-Footnote-2556729
+Ref: String Functions-Footnote-3556977
+Node: Gory Details557064
+Ref: table-sub-escapes558855
+Ref: table-sub-proposed560374
+Ref: table-posix-sub561737
+Ref: table-gensub-escapes563278
+Ref: Gory Details-Footnote-1564101
+Node: I/O Functions564255
+Ref: table-system-return-values570723
+Ref: I/O Functions-Footnote-1572703
+Ref: I/O Functions-Footnote-2572851
+Node: Time Functions572971
+Ref: Time Functions-Footnote-1583642
+Ref: Time Functions-Footnote-2583710
+Ref: Time Functions-Footnote-3583868
+Ref: Time Functions-Footnote-4583979
+Ref: Time Functions-Footnote-5584091
+Ref: Time Functions-Footnote-6584318
+Node: Bitwise Functions584584
+Ref: table-bitwise-ops585178
+Ref: Bitwise Functions-Footnote-1591223
+Ref: Bitwise Functions-Footnote-2591396
+Node: Type Functions591587
+Node: I18N Functions594338
+Node: User-defined595989
+Node: Definition Syntax596794
+Ref: Definition Syntax-Footnote-1602481
+Node: Function Example602552
+Ref: Function Example-Footnote-1605474
+Node: Function Caveats605496
+Node: Calling A Function606014
+Node: Variable Scope606972
+Node: Pass By Value/Reference609966
+Node: Return Statement613465
+Node: Dynamic Typing616444
+Node: Indirect Calls617374
+Ref: Indirect Calls-Footnote-1627626
+Node: Functions Summary627754
+Node: Library Functions630459
+Ref: Library Functions-Footnote-1634066
+Ref: Library Functions-Footnote-2634209
+Node: Library Names634380
+Ref: Library Names-Footnote-1637840
+Ref: Library Names-Footnote-2638063
+Node: General Functions638149
+Node: Strtonum Function639252
+Node: Assert Function642274
+Node: Round Function645600
+Node: Cliff Random Function647140
+Node: Ordinal Functions648156
+Ref: Ordinal Functions-Footnote-1651219
+Ref: Ordinal Functions-Footnote-2651471
+Node: Join Function651681
+Ref: Join Function-Footnote-1653451
+Node: Getlocaltime Function653651
+Node: Readfile Function657393
+Node: Shell Quoting659370
+Node: Data File Management660771
+Node: Filetrans Function661403
+Node: Rewind Function665499
+Node: File Checking667409
+Ref: File Checking-Footnote-1668743
+Node: Empty Files668944
+Node: Ignoring Assigns670923
+Node: Getopt Function672473
+Ref: Getopt Function-Footnote-1683942
+Node: Passwd Functions684142
+Ref: Passwd Functions-Footnote-1692981
+Node: Group Functions693069
+Ref: Group Functions-Footnote-1700967
+Node: Walking Arrays701174
+Node: Library Functions Summary704182
+Node: Library Exercises705588
+Node: Sample Programs706053
+Node: Running Examples706823
+Node: Clones707551
+Node: Cut Program708775
+Node: Egrep Program718704
+Ref: Egrep Program-Footnote-1726216
+Node: Id Program726326
+Node: Split Program730006
+Ref: Split Program-Footnote-1733464
+Node: Tee Program733593
+Node: Uniq Program736383
+Node: Wc Program743809
+Ref: Wc Program-Footnote-1748064
+Node: Miscellaneous Programs748158
+Node: Dupword Program749371
+Node: Alarm Program751401
+Node: Translate Program756256
+Ref: Translate Program-Footnote-1760821
+Node: Labels Program761091
+Ref: Labels Program-Footnote-1764442
+Node: Word Sorting764526
+Node: History Sorting768598
+Node: Extract Program770433
+Node: Simple Sed777963
+Node: Igawk Program781037
+Ref: Igawk Program-Footnote-1795368
+Ref: Igawk Program-Footnote-2795570
+Ref: Igawk Program-Footnote-3795692
+Node: Anagram Program795807
+Node: Signature Program798869
+Node: Programs Summary800116
+Node: Programs Exercises801330
+Ref: Programs Exercises-Footnote-1805459
+Node: Advanced Features805550
+Node: Nondecimal Data807540
+Node: Array Sorting809131
+Node: Controlling Array Traversal809831
+Ref: Controlling Array Traversal-Footnote-1818199
+Node: Array Sorting Functions818317
+Ref: Array Sorting Functions-Footnote-1823408
+Node: Two-way I/O823604
+Ref: Two-way I/O-Footnote-1830156
+Ref: Two-way I/O-Footnote-2830343
+Node: TCP/IP Networking830425
+Node: Profiling833543
+Ref: Profiling-Footnote-1842215
+Node: Advanced Features Summary842538
+Node: Internationalization844382
+Node: I18N and L10N845862
+Node: Explaining gettext846549
+Ref: Explaining gettext-Footnote-1852441
+Ref: Explaining gettext-Footnote-2852626
+Node: Programmer i18n852791
+Ref: Programmer i18n-Footnote-1857740
+Node: Translator i18n857789
+Node: String Extraction858583
+Ref: String Extraction-Footnote-1859715
+Node: Printf Ordering859801
+Ref: Printf Ordering-Footnote-1862587
+Node: I18N Portability862651
+Ref: I18N Portability-Footnote-1865107
+Node: I18N Example865170
+Ref: I18N Example-Footnote-1867976
+Node: Gawk I18N868049
+Node: I18N Summary868694
+Node: Debugger870035
+Node: Debugging871058
+Node: Debugging Concepts871499
+Node: Debugging Terms873308
+Node: Awk Debugging875883
+Node: Sample Debugging Session876789
+Node: Debugger Invocation877323
+Node: Finding The Bug878709
+Node: List of Debugger Commands885187
+Node: Breakpoint Control886520
+Node: Debugger Execution Control890214
+Node: Viewing And Changing Data893576
+Node: Execution Stack896950
+Node: Debugger Info898587
+Node: Miscellaneous Debugger Commands902658
+Node: Readline Support907720
+Node: Limitations908616
+Node: Debugging Summary910725
+Node: Arbitrary Precision Arithmetic912004
+Node: Computer Arithmetic913489
+Ref: table-numeric-ranges917255
+Ref: table-floating-point-ranges917748
+Ref: Computer Arithmetic-Footnote-1918406
+Node: Math Definitions918463
+Ref: table-ieee-formats921779
+Ref: Math Definitions-Footnote-1922382
+Node: MPFR features922487
+Node: FP Math Caution924205
+Ref: FP Math Caution-Footnote-1925277
+Node: Inexactness of computations925646
+Node: Inexact representation926606
+Node: Comparing FP Values927966
+Node: Errors accumulate929048
+Node: Getting Accuracy930481
+Node: Try To Round933191
+Node: Setting precision934090
+Ref: table-predefined-precision-strings934787
+Node: Setting the rounding mode936617
+Ref: table-gawk-rounding-modes936991
+Ref: Setting the rounding mode-Footnote-1940922
+Node: Arbitrary Precision Integers941101
+Ref: Arbitrary Precision Integers-Footnote-1944276
+Node: Checking for MPFR944425
+Node: POSIX Floating Point Problems945899
+Ref: POSIX Floating Point Problems-Footnote-1949770
+Node: Floating point summary949808
+Node: Dynamic Extensions951998
+Node: Extension Intro953551
+Node: Plugin License954817
+Node: Extension Mechanism Outline955614
+Ref: figure-load-extension956053
+Ref: figure-register-new-function957618
+Ref: figure-call-new-function958710
+Node: Extension API Description960772
+Node: Extension API Functions Introduction962414
+Node: General Data Types967954
+Ref: General Data Types-Footnote-1976315
+Node: Memory Allocation Functions976614
+Ref: Memory Allocation Functions-Footnote-1980824
+Node: Constructor Functions980923
+Node: Registration Functions984509
+Node: Extension Functions985194
+Node: Exit Callback Functions990409
+Node: Extension Version String991659
+Node: Input Parsers992322
+Node: Output Wrappers1005043
+Node: Two-way processors1009555
+Node: Printing Messages1011820
+Ref: Printing Messages-Footnote-11012991
+Node: Updating ERRNO1013144
+Node: Requesting Values1013883
+Ref: table-value-types-returned1014620
+Node: Accessing Parameters1015556
+Node: Symbol Table Access1016791
+Node: Symbol table by name1017303
+Node: Symbol table by cookie1019092
+Ref: Symbol table by cookie-Footnote-11023277
+Node: Cached values1023341
+Ref: Cached values-Footnote-11026877
+Node: Array Manipulation1027030
+Ref: Array Manipulation-Footnote-11028121
+Node: Array Data Types1028158
+Ref: Array Data Types-Footnote-11030816
+Node: Array Functions1030908
+Node: Flattening Arrays1035406
+Node: Creating Arrays1042382
+Node: Redirection API1047149
+Node: Extension API Variables1049982
+Node: Extension Versioning1050693
+Ref: gawk-api-version1051122
+Node: Extension GMP/MPFR Versioning1052853
+Node: Extension API Informational Variables1054481
+Node: Extension API Boilerplate1055554
+Node: Changes from API V11059528
+Node: Finding Extensions1061100
+Node: Extension Example1061659
+Node: Internal File Description1062457
+Node: Internal File Ops1066537
+Ref: Internal File Ops-Footnote-11077887
+Node: Using Internal File Ops1078027
+Ref: Using Internal File Ops-Footnote-11080410
+Node: Extension Samples1080684
+Node: Extension Sample File Functions1082213
+Node: Extension Sample Fnmatch1089862
+Node: Extension Sample Fork1091349
+Node: Extension Sample Inplace1092567
+Node: Extension Sample Ord1095784
+Node: Extension Sample Readdir1096620
+Ref: table-readdir-file-types1097509
+Node: Extension Sample Revout1098314
+Node: Extension Sample Rev2way1098903
+Node: Extension Sample Read write array1099643
+Node: Extension Sample Readfile1101585
+Node: Extension Sample Time1102680
+Node: Extension Sample API Tests1104028
+Node: gawkextlib1104520
+Node: Extension summary1107438
+Node: Extension Exercises1111140
+Node: Language History1112638
+Node: V7/SVR3.11114294
+Node: SVR41116446
+Node: POSIX1117880
+Node: BTL1119260
+Node: POSIX/GNU1119989
+Node: Feature History1125767
+Node: Common Extensions1141626
+Node: Ranges and Locales1142909
+Ref: Ranges and Locales-Footnote-11147525
+Ref: Ranges and Locales-Footnote-21147552
+Ref: Ranges and Locales-Footnote-31147787
+Node: Contributors1148008
+Node: History summary1153953
+Node: Installation1155333
+Node: Gawk Distribution1156277
+Node: Getting1156761
+Node: Extracting1157724
+Node: Distribution contents1159362
+Node: Unix Installation1165842
+Node: Quick Installation1166524
+Node: Shell Startup Files1168938
+Node: Additional Configuration Options1170027
+Node: Configuration Philosophy1172320
+Node: Non-Unix Installation1174689
+Node: PC Installation1175149
+Node: PC Binary Installation1175987
+Node: PC Compiling1176422
+Node: PC Using1177539
+Node: Cygwin1180754
+Node: MSYS1181853
+Node: VMS Installation1182354
+Node: VMS Compilation1183145
+Ref: VMS Compilation-Footnote-11184374
+Node: VMS Dynamic Extensions1184432
+Node: VMS Installation Details1186117
+Node: VMS Running1188370
+Node: VMS GNV1192649
+Node: VMS Old Gawk1193384
+Node: Bugs1193855
+Node: Bug address1194518
+Node: Usenet1197310
+Node: Maintainers1198087
+Node: Other Versions1199348
+Node: Installation summary1206110
+Node: Notes1207312
+Node: Compatibility Mode1208177
+Node: Additions1208959
+Node: Accessing The Source1209884
+Node: Adding Code1211321
+Node: New Ports1217540
+Node: Derived Files1222028
+Ref: Derived Files-Footnote-11227674
+Ref: Derived Files-Footnote-21227709
+Ref: Derived Files-Footnote-31228307
+Node: Future Extensions1228421
+Node: Implementation Limitations1229079
+Node: Extension Design1230262
+Node: Old Extension Problems1231416
+Ref: Old Extension Problems-Footnote-11232934
+Node: Extension New Mechanism Goals1232991
+Ref: Extension New Mechanism Goals-Footnote-11236355
+Node: Extension Other Design Decisions1236544
+Node: Extension Future Growth1238657
+Node: Old Extension Mechanism1239493
+Node: Notes summary1241256
+Node: Basic Concepts1242438
+Node: Basic High Level1243119
+Ref: figure-general-flow1243401
+Ref: figure-process-flow1244086
+Ref: Basic High Level-Footnote-11247387
+Node: Basic Data Typing1247572
+Node: Glossary1250900
+Node: Copying1282738
+Node: GNU Free Documentation License1320281
+Node: Index1345401
 
 End Tag Table
diff --git a/doc/gawk.texi b/doc/gawk.texi
index 7b69b52..7dfa3b3 100644
--- a/doc/gawk.texi
+++ b/doc/gawk.texi
@@ -9557,6 +9557,25 @@ the field width.  Here is a list of the format-control letters:
 
 @c @asis for docbook to come out right
 @table @asis
+@item @code{%a}, @code{%A}
+A floating point number of the form
+[@code{-}]@code{0x@var{h}.@var{hhhh}p+-@var{dd}}
+(C99 hexadecimal floating point format).
+For @code{%A},
+uppercase letters are used instead of lowercase ones.
+
+@quotation NOTE
+While the current POSIX standard requires support for @code{%a}
+and @code{%A} in @command{awk}, as far as we know, no other version
+of @command{awk} actually implements it.  It's use is thus highly
+nonportable!
+
+Furthermore, these formats are not available on any system where the
+underlying C library @code{printf()} function does not support them. As
+of this writing, among current systems, only OpenVMS is known to not
+support them.
+@end quotation
+
 @item @code{%c}
 Print a number as a character; thus, @samp{printf "%c",
 65} outputs the letter @samp{A}. The output for a string value is
diff --git a/doc/gawktexi.in b/doc/gawktexi.in
index 6203e1a..f2cb710 100644
--- a/doc/gawktexi.in
+++ b/doc/gawktexi.in
@@ -9156,6 +9156,25 @@ the field width.  Here is a list of the format-control letters:
 
 @c @asis for docbook to come out right
 @table @asis
+@item @code{%a}, @code{%A}
+A floating point number of the form
+[@code{-}]@code{0x@var{h}.@var{hhhh}p+-@var{dd}}
+(C99 hexadecimal floating point format).
+For @code{%A},
+uppercase letters are used instead of lowercase ones.
+
+@quotation NOTE
+While the current POSIX standard requires support for @code{%a}
+and @code{%A} in @command{awk}, as far as we know, no other version
+of @command{awk} actually implements it.  It's use is thus highly
+nonportable!
+
+Furthermore, these formats are not available on any system where the
+underlying C library @code{printf()} function does not support them. As
+of this writing, among current systems, only OpenVMS is known to not
+support them.
+@end quotation
+
 @item @code{%c}
 Print a number as a character; thus, @samp{printf "%c",
 65} outputs the letter @samp{A}. The output for a string value is
diff --git a/doc/wordlist b/doc/wordlist
index 3c3c7e9..3763056 100644
--- a/doc/wordlist
+++ b/doc/wordlist
@@ -865,6 +865,7 @@ dayname
 db
 dcgettext
 dcngettext
+dd
 ddd
 de
 deallocations
@@ -1132,6 +1133,7 @@ helpfull
 helplib
 hfil
 hh
+hhhh
 hhob
 histsort
 hlp
diff --git a/doc/wordlist2 b/doc/wordlist2
index 9275fdb..7bf7ad3 100644
--- a/doc/wordlist2
+++ b/doc/wordlist2
@@ -60,6 +60,7 @@ distclean
 docbook
 du
 dvi
+elled
 emph
 en
 env
diff --git a/pc/config.h b/pc/config.h
index de2b7ec..2ec5352 100644
--- a/pc/config.h
+++ b/pc/config.h
@@ -473,6 +473,9 @@
 /* Define to the version of this package. */
 #define PACKAGE_VERSION "4.2.1"
 
+/* Define to 1 if *printf supports %a format */
+#define PRINTF_HAS_A_FORMAT 1
+
 /* Define to 1 if *printf supports %F format */
 #ifdef __DJGPP__
 #define PRINTF_HAS_F_FORMAT 1
diff --git a/pc/config.sed b/pc/config.sed
index 5b3cc32..a7ba878 100644
--- a/pc/config.sed
+++ b/pc/config.sed
@@ -273,6 +273,8 @@ s/^#undef HAVE_VPRINTF *$/#define HAVE_VPRINTF 1/
 #ifdef __DJGPP__\
 #define HAVE__BOOL 1\
 #endif
+/^#undef PRINTF_HAS_A_FORMAT *$/c\
+#define PRINTF_HAS_A_FORMAT 1
 /^#undef PRINTF_HAS_F_FORMAT *$/c\
 #ifdef __DJGPP__\
 #define PRINTF_HAS_F_FORMAT 1\
-- 
2.14.4

